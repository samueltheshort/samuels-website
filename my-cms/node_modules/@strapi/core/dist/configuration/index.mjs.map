{"version":3,"file":"index.mjs","sources":["../../src/configuration/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-var-requires */\nimport os from 'os';\nimport path from 'path';\nimport _ from 'lodash';\nimport { omit } from 'lodash/fp';\nimport dotenv from 'dotenv';\nimport type { Core } from '@strapi/types';\nimport { strings } from '@strapi/utils';\n\nimport { getConfigUrls, getAbsoluteAdminUrl, getAbsoluteServerUrl } from './urls';\nimport loadConfigDir from './config-loader';\nimport { getDirs } from './get-dirs';\n\nimport type { StrapiOptions } from '../Strapi';\n\ndotenv.config({ path: process.env.ENV_PATH });\n\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'development';\n\nconst { version: strapiVersion } = require(path.join(__dirname, '../../package.json'));\n\nconst defaultConfig = {\n  server: {\n    host: process.env.HOST || os.hostname() || 'localhost',\n    port: Number(process.env.PORT) || 1337,\n    proxy: false,\n    cron: { enabled: false },\n    admin: { autoOpen: false },\n    dirs: { public: './public' },\n    transfer: {\n      remote: {\n        enabled: true,\n      },\n    },\n    logger: {\n      updates: {\n        enabled: true,\n      },\n      startup: {\n        enabled: true,\n      },\n    },\n  } satisfies Partial<Core.Config.Server>,\n  admin: {} satisfies Partial<Core.Config.Admin>,\n  api: {\n    rest: {\n      prefix: '/api',\n    },\n  } satisfies Partial<Core.Config.Api>,\n};\n\nexport const loadConfiguration = (opts: StrapiOptions) => {\n  const { appDir, distDir, autoReload = false, serveAdminPanel = true } = opts;\n\n  const pkgJSON = require(path.resolve(appDir, 'package.json'));\n\n  const configDir = path.resolve(distDir || process.cwd(), 'config');\n\n  const rootConfig = {\n    launchedAt: Date.now(),\n    autoReload,\n    environment: process.env.NODE_ENV,\n    uuid: _.get(pkgJSON, 'strapi.uuid'),\n    packageJsonStrapi: _.omit(_.get(pkgJSON, 'strapi', {}), 'uuid'),\n    info: {\n      ...pkgJSON,\n      strapi: strapiVersion,\n    },\n    admin: {\n      serveAdminPanel,\n    },\n  };\n\n  // See packages/core/core/src/domain/module/index.ts for plugin config loading\n  const baseConfig = omit('plugins', loadConfigDir(configDir)); // plugin config will be loaded later\n\n  const envDir = path.resolve(configDir, 'env', process.env.NODE_ENV as string);\n  const envConfig = loadConfigDir(envDir);\n\n  const config = _.merge(rootConfig, defaultConfig, baseConfig, envConfig);\n\n  const { serverUrl, adminUrl } = getConfigUrls(config);\n\n  const serverAbsoluteUrl = getAbsoluteServerUrl(config);\n  const adminAbsoluteUrl = getAbsoluteAdminUrl(config);\n\n  const sameOrigin = new URL(adminAbsoluteUrl).origin === new URL(serverAbsoluteUrl).origin;\n\n  const adminPath = sameOrigin\n    ? adminUrl.replace(strings.getCommonPath(serverUrl, adminUrl), '')\n    : new URL(adminUrl).pathname;\n\n  _.set(config, 'server.url', serverUrl);\n  _.set(config, 'server.absoluteUrl', serverAbsoluteUrl);\n  _.set(config, 'admin.url', adminUrl);\n  _.set(config, 'admin.path', adminPath);\n  _.set(config, 'admin.absoluteUrl', adminAbsoluteUrl);\n  _.set(config, 'dirs', getDirs(opts, config));\n\n  return config;\n};\n"],"names":[],"mappings":";;;;;;;;;AAeA,OAAO,OAAO,EAAE,MAAM,QAAQ,IAAI,UAAU;AAE5C,QAAQ,IAAI,WAAW,QAAQ,IAAI,YAAY;AAE/C,MAAM,EAAE,SAAS,cAAc,IAAI,QAAQ,KAAK,KAAK,WAAW,oBAAoB,CAAC;AAErF,MAAM,gBAAgB;AAAA,EACpB,QAAQ;AAAA,IACN,MAAM,QAAQ,IAAI,QAAQ,GAAG,cAAc;AAAA,IAC3C,MAAM,OAAO,QAAQ,IAAI,IAAI,KAAK;AAAA,IAClC,OAAO;AAAA,IACP,MAAM,EAAE,SAAS,MAAM;AAAA,IACvB,OAAO,EAAE,UAAU,MAAM;AAAA,IACzB,MAAM,EAAE,QAAQ,WAAW;AAAA,IAC3B,UAAU;AAAA,MACR,QAAQ;AAAA,QACN,SAAS;AAAA,MAAA;AAAA,IAEb;AAAA,IACA,QAAQ;AAAA,MACN,SAAS;AAAA,QACP,SAAS;AAAA,MACX;AAAA,MACA,SAAS;AAAA,QACP,SAAS;AAAA,MAAA;AAAA,IACX;AAAA,EAEJ;AAAA,EACA,OAAO,CAAC;AAAA,EACR,KAAK;AAAA,IACH,MAAM;AAAA,MACJ,QAAQ;AAAA,IAAA;AAAA,EACV;AAEJ;AAEa,MAAA,oBAAoB,CAAC,SAAwB;AACxD,QAAM,EAAE,QAAQ,SAAS,aAAa,OAAO,kBAAkB,SAAS;AAExE,QAAM,UAAU,QAAQ,KAAK,QAAQ,QAAQ,cAAc,CAAC;AAE5D,QAAM,YAAY,KAAK,QAAQ,WAAW,QAAQ,OAAO,QAAQ;AAEjE,QAAM,aAAa;AAAA,IACjB,YAAY,KAAK,IAAI;AAAA,IACrB;AAAA,IACA,aAAa,QAAQ,IAAI;AAAA,IACzB,MAAM,EAAE,IAAI,SAAS,aAAa;AAAA,IAClC,mBAAmB,EAAE,KAAK,EAAE,IAAI,SAAS,UAAU,EAAE,GAAG,MAAM;AAAA,IAC9D,MAAM;AAAA,MACJ,GAAG;AAAA,MACH,QAAQ;AAAA,IACV;AAAA,IACA,OAAO;AAAA,MACL;AAAA,IAAA;AAAA,EAEJ;AAGA,QAAM,aAAa,KAAK,WAAW,cAAc,SAAS,CAAC;AAE3D,QAAM,SAAS,KAAK,QAAQ,WAAW,OAAO,QAAQ,IAAI,QAAkB;AACtE,QAAA,YAAY,cAAc,MAAM;AAEtC,QAAM,SAAS,EAAE,MAAM,YAAY,eAAe,YAAY,SAAS;AAEvE,QAAM,EAAE,WAAW,aAAa,cAAc,MAAM;AAE9C,QAAA,oBAAoB,qBAAqB,MAAM;AAC/C,QAAA,mBAAmB,oBAAoB,MAAM;AAE7C,QAAA,aAAa,IAAI,IAAI,gBAAgB,EAAE,WAAW,IAAI,IAAI,iBAAiB,EAAE;AAEnF,QAAM,YAAY,aACd,SAAS,QAAQ,QAAQ,cAAc,WAAW,QAAQ,GAAG,EAAE,IAC/D,IAAI,IAAI,QAAQ,EAAE;AAEpB,IAAA,IAAI,QAAQ,cAAc,SAAS;AACnC,IAAA,IAAI,QAAQ,sBAAsB,iBAAiB;AACnD,IAAA,IAAI,QAAQ,aAAa,QAAQ;AACjC,IAAA,IAAI,QAAQ,cAAc,SAAS;AACnC,IAAA,IAAI,QAAQ,qBAAqB,gBAAgB;AACnD,IAAE,IAAI,QAAQ,QAAQ,QAAQ,MAAM,MAAM,CAAC;AAEpC,SAAA;AACT;"}