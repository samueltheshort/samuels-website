{"version":3,"file":"get-enabled-plugins.mjs","sources":["../../../src/loaders/plugins/get-enabled-plugins.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-var-requires */\nimport { dirname, join, resolve } from 'path';\nimport { statSync, existsSync } from 'fs';\nimport _ from 'lodash';\nimport { get, pickBy, defaultsDeep, map, prop, pipe } from 'lodash/fp';\nimport { strings } from '@strapi/utils';\nimport type { Core } from '@strapi/types';\nimport { getUserPluginsConfig } from './get-user-plugins-config';\n\ninterface PluginMeta {\n  enabled: boolean;\n  pathToPlugin?: string;\n  info: Record<string, unknown>;\n  packageInfo?: Record<string, unknown>;\n}\n\ntype PluginMetas = Record<string, PluginMeta>;\n\ninterface PluginInfo {\n  name: string;\n  kind: string;\n}\n\ninterface PluginDeclaration {\n  enabled: boolean;\n  resolve: string;\n  isModule: boolean;\n}\n\n/**\n * otherwise known as \"core features\"\n *\n * NOTE: These are excluded from the content manager plugin list, as they are always enabled.\n *       See admin.ts server controller on the content-manager plugin for more details.\n */\nconst INTERNAL_PLUGINS = [\n  '@strapi/content-manager',\n  '@strapi/content-type-builder',\n  '@strapi/email',\n  '@strapi/upload',\n  '@strapi/i18n',\n  '@strapi/content-releases',\n  '@strapi/review-workflows',\n];\n\nconst isStrapiPlugin = (info: PluginInfo) => get('strapi.kind', info) === 'plugin';\n\nconst validatePluginName = (pluginName: string) => {\n  if (!strings.isKebabCase(pluginName)) {\n    throw new Error(`Plugin name \"${pluginName}\" is not in kebab (an-example-of-kebab-case)`);\n  }\n};\n\nconst toDetailedDeclaration = (declaration: boolean | PluginDeclaration) => {\n  if (typeof declaration === 'boolean') {\n    return { enabled: declaration };\n  }\n\n  const detailedDeclaration: { enabled: boolean; pathToPlugin?: string } = {\n    enabled: declaration.enabled,\n  };\n\n  if (declaration?.resolve) {\n    let pathToPlugin = '';\n\n    if (declaration.isModule) {\n      /**\n       * we only want the node_module here, not the package.json\n       */\n      pathToPlugin = join(declaration.resolve, '..');\n    } else {\n      try {\n        pathToPlugin = dirname(require.resolve(declaration.resolve));\n      } catch (e) {\n        pathToPlugin = resolve(strapi.dirs.app.root, declaration.resolve);\n\n        if (!existsSync(pathToPlugin) || !statSync(pathToPlugin).isDirectory()) {\n          throw new Error(`${declaration.resolve} couldn't be resolved`);\n        }\n      }\n    }\n\n    detailedDeclaration.pathToPlugin = pathToPlugin;\n  }\n\n  return detailedDeclaration;\n};\n\nexport const getEnabledPlugins = async (strapi: Core.Strapi, { client } = { client: false }) => {\n  const internalPlugins: PluginMetas = {};\n\n  for (const dep of INTERNAL_PLUGINS) {\n    const packagePath = join(dep, 'package.json');\n\n    // NOTE: internal plugins should be resolved from the strapi package\n    const packageModulePath = require.resolve(packagePath, {\n      paths: [require.resolve('@strapi/strapi/package.json'), process.cwd()],\n    });\n\n    const packageInfo = require(packageModulePath);\n\n    validatePluginName(packageInfo.strapi.name);\n    internalPlugins[packageInfo.strapi.name] = {\n      ...toDetailedDeclaration({ enabled: true, resolve: packageModulePath, isModule: client }),\n      info: packageInfo.strapi,\n      packageInfo,\n    };\n  }\n\n  const installedPlugins: PluginMetas = {};\n  const dependencies = strapi.config.get('info.dependencies', {});\n\n  for (const dep of Object.keys(dependencies)) {\n    const packagePath = join(dep, 'package.json');\n    let packageInfo;\n    try {\n      packageInfo = require(packagePath);\n    } catch {\n      continue;\n    }\n\n    if (isStrapiPlugin(packageInfo)) {\n      validatePluginName(packageInfo.strapi.name);\n      installedPlugins[packageInfo.strapi.name] = {\n        ...toDetailedDeclaration({ enabled: true, resolve: packagePath, isModule: client }),\n        info: {\n          ...packageInfo.strapi,\n          packageName: packageInfo.name,\n        },\n        packageInfo,\n      };\n    }\n  }\n\n  const declaredPlugins: PluginMetas = {};\n  const userPluginsConfig = await getUserPluginsConfig();\n\n  _.forEach(userPluginsConfig, (declaration, pluginName) => {\n    validatePluginName(pluginName);\n\n    declaredPlugins[pluginName] = {\n      ...toDetailedDeclaration(declaration),\n      info: {},\n    };\n\n    const { pathToPlugin } = declaredPlugins[pluginName];\n\n    // for manually resolved plugins\n    if (pathToPlugin) {\n      const packagePath = join(pathToPlugin, 'package.json');\n      const packageInfo = require(packagePath);\n\n      if (isStrapiPlugin(packageInfo)) {\n        declaredPlugins[pluginName].info = packageInfo.strapi || {};\n        declaredPlugins[pluginName].packageInfo = packageInfo;\n      }\n    }\n  });\n\n  const declaredPluginsResolves = map(prop('pathToPlugin'), declaredPlugins);\n  const installedPluginsNotAlreadyUsed = pickBy(\n    (p) => !declaredPluginsResolves.includes(p.pathToPlugin),\n    installedPlugins\n  );\n\n  const enabledPlugins = pipe(\n    defaultsDeep(declaredPlugins),\n    defaultsDeep(installedPluginsNotAlreadyUsed),\n    pickBy((p: PluginMeta) => p.enabled)\n  )(internalPlugins);\n\n  return enabledPlugins;\n};\n"],"names":["strapi"],"mappings":"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"}