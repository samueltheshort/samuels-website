{"version":3,"file":"compose-endpoint.js","sources":["../../../src/services/server/compose-endpoint.ts"],"sourcesContent":["import { toLower, castArray, trim, prop, isNil } from 'lodash/fp';\nimport type { Core, UID } from '@strapi/types';\nimport { errors } from '@strapi/utils';\nimport Router from '@koa/router';\n\nimport compose from 'koa-compose';\nimport { resolveRouteMiddlewares } from './middleware';\nimport { createPolicicesMiddleware } from './policy';\n\nconst getMethod = (route: Core.Route) => {\n  return trim(toLower(route.method)) as Lowercase<Core.Route['method']>;\n};\n\nconst getPath = (route: Core.Route) => trim(route.path);\n\nconst createRouteInfoMiddleware =\n  (routeInfo: Core.Route): Core.MiddlewareHandler =>\n  (ctx, next) => {\n    const route = {\n      ...routeInfo,\n      config: routeInfo.config || {},\n    };\n\n    ctx.state.route = route;\n    return next();\n  };\n\nconst getAuthConfig = prop('config.auth');\n\nconst createAuthorizeMiddleware =\n  (strapi: Core.Strapi): Core.MiddlewareHandler =>\n  async (ctx, next) => {\n    const { auth, route } = ctx.state;\n\n    const authService = strapi.get('auth');\n\n    try {\n      await authService.verify(auth, getAuthConfig(route));\n\n      return await next();\n    } catch (error) {\n      if (error instanceof errors.UnauthorizedError) {\n        return ctx.unauthorized();\n      }\n\n      if (error instanceof errors.ForbiddenError) {\n        // allow PolicyError as an exception to throw a publicly visible message in the API\n        if (error instanceof errors.PolicyError) {\n          throw error;\n        }\n        return ctx.forbidden();\n      }\n\n      throw error;\n    }\n  };\n\nconst createAuthenticateMiddleware =\n  (strapi: Core.Strapi): Core.MiddlewareHandler =>\n  async (ctx, next) => {\n    return strapi.get('auth').authenticate(ctx, next);\n  };\n\nconst returnBodyMiddleware: Core.MiddlewareHandler = async (ctx, next) => {\n  const values = await next();\n\n  if (isNil(ctx.body) && !isNil(values)) {\n    ctx.body = values;\n  }\n};\n\nexport default (strapi: Core.Strapi) => {\n  const authenticate = createAuthenticateMiddleware(strapi);\n  const authorize = createAuthorizeMiddleware(strapi);\n\n  return (route: Core.Route, { router }: { router: Router }) => {\n    try {\n      const method = getMethod(route);\n      const path = getPath(route);\n\n      const middlewares = resolveRouteMiddlewares(route, strapi);\n\n      const action = getAction(route, strapi);\n\n      const routeHandler = compose([\n        createRouteInfoMiddleware(route),\n        authenticate,\n        authorize,\n        createPolicicesMiddleware(route, strapi),\n        ...middlewares,\n        returnBodyMiddleware,\n        ...castArray(action),\n      ]);\n\n      router[method](path, routeHandler);\n    } catch (error) {\n      if (error instanceof Error) {\n        error.message = `Error creating endpoint ${route.method} ${route.path}: ${error.message}`;\n      }\n\n      throw error;\n    }\n  };\n};\n\nconst getController = (\n  name: string,\n  { pluginName, apiName }: Core.RouteInfo,\n  strapi: Core.Strapi\n) => {\n  let ctrl: Core.Controller | undefined;\n\n  if (pluginName) {\n    if (pluginName === 'admin') {\n      ctrl = strapi.controller(`admin::${name}`);\n    } else {\n      ctrl = strapi.plugin(pluginName).controller(name);\n    }\n  } else if (apiName) {\n    ctrl = strapi.controller(`api::${apiName}.${name}`);\n  }\n\n  if (!ctrl) {\n    return strapi.controller(name as UID.Controller);\n  }\n\n  return ctrl;\n};\n\nconst extractHandlerParts = (name: string) => {\n  const controllerName = name.slice(0, name.lastIndexOf('.'));\n  const actionName = name.slice(name.lastIndexOf('.') + 1);\n\n  return { controllerName, actionName };\n};\n\nconst getAction = (route: Core.Route, strapi: Core.Strapi) => {\n  const { handler, info } = route;\n  const { pluginName, apiName, type } = info ?? {};\n\n  if (Array.isArray(handler) || typeof handler === 'function') {\n    return handler;\n  }\n\n  const { controllerName, actionName } = extractHandlerParts(trim(handler));\n\n  const controller = getController(controllerName, { pluginName, apiName, type }, strapi);\n\n  if (typeof controller[actionName] !== 'function') {\n    throw new Error(`Handler not found \"${handler}\"`);\n  }\n\n  if (Symbol.for('__type__') in controller[actionName]) {\n    (controller[actionName] as any)[Symbol.for('__type__')].push(type);\n  } else {\n    (controller[actionName] as any)[Symbol.for('__type__')] = [type];\n  }\n\n  return controller[actionName].bind(controller);\n};\n"],"names":["trim","toLower","prop","errors","isNil","resolveRouteMiddlewares","compose","createPolicicesMiddleware","castArray"],"mappings":"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"}