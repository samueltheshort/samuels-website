{"version":3,"file":"http-server.mjs","sources":["../../../src/services/server/http-server.ts"],"sourcesContent":["import http from 'http';\nimport type { Socket } from 'net';\nimport Koa from 'koa';\nimport type { Core } from '@strapi/types';\n\nexport interface Server extends http.Server {\n  destroy: () => Promise<void>;\n}\n\nconst createHTTPServer = (strapi: Core.Strapi, koaApp: Koa): Server => {\n  const connections = new Set<Socket>();\n\n  // lazy creation of the request listener\n  let handler: http.RequestListener;\n  const listener: http.RequestListener = function handleRequest(req, res) {\n    if (!handler) {\n      handler = koaApp.callback();\n    }\n\n    return handler(req, res);\n  };\n\n  const options = strapi.config.get<http.ServerOptions>('server.http.serverOptions', {});\n\n  const server: http.Server = http.createServer(options, listener);\n\n  server.on('connection', (connection) => {\n    connections.add(connection);\n\n    connection.on('close', () => {\n      connections.delete(connection);\n    });\n  });\n\n  // handle port in use cleanly\n  server.on('error', (err) => {\n    if ('code' in err && 'port' in err && err.code === 'EADDRINUSE') {\n      return strapi.stopWithError(`The port ${err.port} is already used by another application.`);\n    }\n\n    strapi.log.error(err);\n  });\n\n  const destroy = async () => {\n    for (const connection of connections) {\n      connection.destroy();\n\n      connections.delete(connection);\n    }\n\n    if (!server.listening) {\n      return;\n    }\n\n    return new Promise<void>((resolve, reject) => {\n      server.close((error) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n  };\n\n  return Object.assign(server, { destroy });\n};\n\nexport { createHTTPServer };\n"],"names":[],"mappings":";AASM,MAAA,mBAAmB,CAAC,QAAqB,WAAwB;AAC/D,QAAA,kCAAkB,IAAY;AAGhC,MAAA;AACJ,QAAM,WAAiC,SAAS,cAAc,KAAK,KAAK;AACtE,QAAI,CAAC,SAAS;AACZ,gBAAU,OAAO,SAAS;AAAA,IAAA;AAGrB,WAAA,QAAQ,KAAK,GAAG;AAAA,EACzB;AAEA,QAAM,UAAU,OAAO,OAAO,IAAwB,6BAA6B,CAAA,CAAE;AAErF,QAAM,SAAsB,KAAK,aAAa,SAAS,QAAQ;AAExD,SAAA,GAAG,cAAc,CAAC,eAAe;AACtC,gBAAY,IAAI,UAAU;AAEf,eAAA,GAAG,SAAS,MAAM;AAC3B,kBAAY,OAAO,UAAU;AAAA,IAAA,CAC9B;AAAA,EAAA,CACF;AAGM,SAAA,GAAG,SAAS,CAAC,QAAQ;AAC1B,QAAI,UAAU,OAAO,UAAU,OAAO,IAAI,SAAS,cAAc;AAC/D,aAAO,OAAO,cAAc,YAAY,IAAI,IAAI,0CAA0C;AAAA,IAAA;AAGrF,WAAA,IAAI,MAAM,GAAG;AAAA,EAAA,CACrB;AAED,QAAM,UAAU,YAAY;AAC1B,eAAW,cAAc,aAAa;AACpC,iBAAW,QAAQ;AAEnB,kBAAY,OAAO,UAAU;AAAA,IAAA;AAG3B,QAAA,CAAC,OAAO,WAAW;AACrB;AAAA,IAAA;AAGF,WAAO,IAAI,QAAc,CAAC,SAAS,WAAW;AACrC,aAAA,MAAM,CAAC,UAAU;AACtB,YAAI,OAAO;AACT,iBAAO,KAAK;AAAA,QAAA,OACP;AACG,kBAAA;AAAA,QAAA;AAAA,MACV,CACD;AAAA,IAAA,CACF;AAAA,EACH;AAEA,SAAO,OAAO,OAAO,QAAQ,EAAE,SAAS;AAC1C;"}