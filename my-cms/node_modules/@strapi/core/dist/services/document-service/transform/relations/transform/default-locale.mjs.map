{"version":3,"file":"default-locale.mjs","sources":["../../../../../../src/services/document-service/transform/relations/transform/default-locale.ts"],"sourcesContent":["import type { UID } from '@strapi/types';\n\nimport { getDefaultLocale, isLocalizedContentType } from '../utils/i18n';\nimport { mapRelation, traverseEntityRelations } from '../utils/map-relation';\n\n/**\n * In scenarios like Non i18n CT -> i18n CT\n * relations can be connected to multiple locales,\n * in case user does not provide the locale, this sets it to the default one.\n */\nconst setDefaultLocaleToRelations = (data: Record<string, any>, uid: UID.Schema) => {\n  // I18n CT -> anything will already have a locale set (source locale)\n  if (isLocalizedContentType(uid)) {\n    return data;\n  }\n\n  // Store the default locale to avoid multiple calls\n  let defaultLocale: string;\n\n  /**\n   * Traverse the entity input data and set the default locale to relations\n   */\n  return traverseEntityRelations(\n    async ({ key, value }, { set }) => {\n      /**\n       * Assign default locale on long hand expressed relations\n       * e.g { documentId } -> { documentId, locale }\n       */\n      const relation = await mapRelation(async (relation) => {\n        if (!relation || !relation?.documentId || relation?.locale) {\n          return relation;\n        }\n\n        // Set default locale if not provided\n        if (!defaultLocale) {\n          defaultLocale = await getDefaultLocale();\n        }\n\n        // Assign default locale to the positional argument\n        const position = relation.position;\n        if (position && typeof position === 'object' && !position.locale) {\n          relation.position.locale = defaultLocale;\n        }\n\n        return { ...relation, locale: defaultLocale };\n      }, value as any);\n\n      // @ts-expect-error - fix type\n      set(key, relation);\n    },\n    { schema: strapi.getModel(uid), getModel: strapi.getModel.bind(strapi) },\n    data\n  );\n};\n\nexport { setDefaultLocaleToRelations };\n"],"names":["traverseEntityRelations","mapRelation","relation"],"mappings":";;AAUM,MAAA,8BAA8B,CAAC,MAA2B,QAAoB;AAE9E,MAAA,uBAAuB,GAAG,GAAG;AACxB,WAAA;AAAA,EAAA;AAIL,MAAA;AAKG,SAAAA;AAAAA,IACL,OAAO,EAAE,KAAK,SAAS,EAAE,UAAU;AAKjC,YAAM,WAAW,MAAMC,mBAAY,OAAOC,cAAa;AACrD,YAAI,CAACA,aAAY,CAACA,WAAU,cAAcA,WAAU,QAAQ;AACnDA,iBAAAA;AAAAA,QAAA;AAIT,YAAI,CAAC,eAAe;AAClB,0BAAgB,MAAM,iBAAiB;AAAA,QAAA;AAIzC,cAAM,WAAWA,UAAS;AAC1B,YAAI,YAAY,OAAO,aAAa,YAAY,CAAC,SAAS,QAAQ;AAChEA,oBAAS,SAAS,SAAS;AAAA,QAAA;AAG7B,eAAO,EAAE,GAAGA,WAAU,QAAQ,cAAc;AAAA,SAC3C,KAAY;AAGf,UAAI,KAAK,QAAQ;AAAA,IACnB;AAAA,IACA,EAAE,QAAQ,OAAO,SAAS,GAAG,GAAG,UAAU,OAAO,SAAS,KAAK,MAAM,EAAE;AAAA,IACvE;AAAA,EACF;AACF;"}