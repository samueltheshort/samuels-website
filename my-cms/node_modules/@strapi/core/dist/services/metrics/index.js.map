{"version":3,"file":"index.js","sources":["../../../src/services/metrics/index.ts"],"sourcesContent":["/**\n * Strapi telemetry package.\n * You can learn more at https://docs.strapi.io/developer-docs/latest/getting-started/usage-information.html\n */\n\nimport { Job, scheduleJob } from 'node-schedule';\nimport type { Core } from '@strapi/types';\n\nimport wrapWithRateLimit from './rate-limiter';\nimport createSender from './sender';\nimport createMiddleware from './middleware';\nimport isTruthy from './is-truthy';\n\nconst LIMITED_EVENTS = [\n  'didSaveMediaWithAlternativeText',\n  'didSaveMediaWithCaption',\n  'didDisableResponsiveDimensions',\n  'didEnableResponsiveDimensions',\n  'didInitializePluginUpload',\n];\n\nconst createTelemetryInstance = (strapi: Core.Strapi) => {\n  const uuid = strapi.config.get('uuid');\n  const telemetryDisabled = strapi.config.get('packageJsonStrapi.telemetryDisabled');\n  const isDisabled =\n    !uuid || isTruthy(process.env.STRAPI_TELEMETRY_DISABLED) || isTruthy(telemetryDisabled);\n\n  const crons: Job[] = [];\n  const sender = createSender(strapi);\n  const sendEvent = wrapWithRateLimit(sender, { limitedEvents: LIMITED_EVENTS });\n\n  return {\n    get isDisabled() {\n      return isDisabled;\n    },\n\n    register() {\n      if (!isDisabled) {\n        const pingCron = scheduleJob('0 0 12 * * *', () => sendEvent('ping'));\n        crons.push(pingCron);\n\n        strapi.server.use(createMiddleware({ sendEvent }));\n      }\n    },\n\n    bootstrap() {},\n\n    destroy() {\n      // Clear open handles\n      crons.forEach((cron) => cron.cancel());\n    },\n\n    async send(event: string, payload: Record<string, unknown> = {}) {\n      if (isDisabled) return true;\n      return sendEvent(event, payload);\n    },\n  };\n};\n\nexport default createTelemetryInstance;\n"],"names":["sender","createSender","wrapWithRateLimit","scheduleJob","createMiddleware"],"mappings":";;;;;;AAaA,MAAM,iBAAiB;AAAA,EACrB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEM,MAAA,0BAA0B,CAAC,WAAwB;AACvD,QAAM,OAAO,OAAO,OAAO,IAAI,MAAM;AACrC,QAAM,oBAAoB,OAAO,OAAO,IAAI,qCAAqC;AAC3E,QAAA,aACJ,CAAC,QAAQ,SAAS,QAAQ,IAAI,yBAAyB,KAAK,SAAS,iBAAiB;AAExF,QAAM,QAAe,CAAC;AAChB,QAAAA,WAASC,OAAa,MAAM;AAClC,QAAM,YAAYC,YAAkBF,UAAQ,EAAE,eAAe,gBAAgB;AAEtE,SAAA;AAAA,IACL,IAAI,aAAa;AACR,aAAA;AAAA,IACT;AAAA,IAEA,WAAW;AACT,UAAI,CAAC,YAAY;AACf,cAAM,WAAWG,aAAAA,YAAY,gBAAgB,MAAM,UAAU,MAAM,CAAC;AACpE,cAAM,KAAK,QAAQ;AAEnB,eAAO,OAAO,IAAIC,WAAiB,EAAE,UAAW,CAAA,CAAC;AAAA,MAAA;AAAA,IAErD;AAAA,IAEA,YAAY;AAAA,IAAC;AAAA,IAEb,UAAU;AAER,YAAM,QAAQ,CAAC,SAAS,KAAK,QAAQ;AAAA,IACvC;AAAA,IAEA,MAAM,KAAK,OAAe,UAAmC,IAAI;AAC/D,UAAI,WAAmB,QAAA;AAChB,aAAA,UAAU,OAAO,OAAO;AAAA,IAAA;AAAA,EAEnC;AACF;;"}