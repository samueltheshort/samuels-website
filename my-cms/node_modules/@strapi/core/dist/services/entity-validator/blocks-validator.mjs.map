{"version":3,"file":"blocks-validator.mjs","sources":["../../../src/services/entity-validator/blocks-validator.ts"],"sourcesContent":["import { yup } from '@strapi/utils';\n\nconst textNodeValidator = yup.object().shape({\n  type: yup.string().equals(['text']).required(),\n  text: yup\n    .string()\n    .test(\n      'is-valid-text',\n      'Text must be defined with at least an empty string',\n      (text: unknown) => {\n        return typeof text === 'string' || text === '';\n      }\n    ),\n  bold: yup.boolean(),\n  italic: yup.boolean(),\n  underline: yup.boolean(),\n  strikethrough: yup.boolean(),\n  code: yup.boolean(),\n});\n\nconst checkValidLink = (link: string) => {\n  try {\n    // eslint-disable-next-line no-new\n    new URL(link.startsWith('/') ? `https://strapi.io${link}` : link);\n  } catch (error) {\n    return false;\n  }\n  return true;\n};\n\nconst linkNodeValidator = yup.object().shape({\n  type: yup.string().equals(['link']).required(),\n  url: yup\n    .string()\n    .test('invalid-url', 'Please specify a valid link.', (value) => checkValidLink(value ?? '')),\n  children: yup.array().of(textNodeValidator).required(),\n});\n\n// TODO: remove any with a correct Type\nconst inlineNodeValidator: any = yup.lazy((value: { type: string }) => {\n  switch (value.type) {\n    case 'text':\n      return textNodeValidator;\n    case 'link':\n      return linkNodeValidator;\n    default:\n      return yup.mixed().test('invalid-type', 'Inline node must be Text or Link', () => {\n        return false;\n      });\n  }\n});\n\nconst paragraphNodeValidator = yup.object().shape({\n  type: yup.string().equals(['paragraph']).required(),\n  children: yup\n    .array()\n    .of(inlineNodeValidator)\n    .min(1, 'Paragraph node children must have at least one Text or Link node')\n    .required(),\n});\n\nconst headingNodeValidator = yup.object().shape({\n  type: yup.string().equals(['heading']).required(),\n  level: yup.number().oneOf([1, 2, 3, 4, 5, 6]).required(),\n  children: yup\n    .array()\n    .of(inlineNodeValidator)\n    .min(1, 'Heading node children must have at least one Text or Link node')\n    .required(),\n});\n\nconst quoteNodeValidator = yup.object().shape({\n  type: yup.string().equals(['quote']).required(),\n  children: yup\n    .array()\n    .of(inlineNodeValidator)\n    .min(1, 'Quote node children must have at least one Text or Link node')\n    .required(),\n});\n\nconst codeBlockValidator = yup.object().shape({\n  type: yup.string().equals(['code']).required(),\n  syntax: yup.string().nullable(),\n  children: yup\n    .array()\n    .of(textNodeValidator)\n    .min(1, 'Quote node children must have at least one Text or Link node')\n    .required(),\n});\n\nconst listItemNode = yup.object().shape({\n  type: yup.string().equals(['list-item']).required(),\n  children: yup.array().of(inlineNodeValidator).required(),\n});\n\n// Allow children to be either a listItemNode or a listNode itself\n// @ts-expect-error - listChildrenValidator needs a type\nconst listChildrenValidator = yup.lazy((value: { type: string }) => {\n  switch (value.type) {\n    case 'list':\n      return listNodeValidator;\n    case 'list-item':\n      return listItemNode;\n    default:\n      return yup.mixed().test('invalid-type', 'Inline node must be list-item or list', () => {\n        return false;\n      });\n  }\n});\n\n// @ts-expect-error - listNodeValidator needs a type\nconst listNodeValidator = yup.object().shape({\n  type: yup.string().equals(['list']).required(),\n  format: yup.string().equals(['ordered', 'unordered']).required(),\n  children: yup\n    .array()\n    .of(listChildrenValidator)\n    .min(1, 'List node children must have at least one ListItem or ListNode')\n    .required(),\n});\n\nconst imageNodeValidator = yup.object().shape({\n  type: yup.string().equals(['image']).required(),\n  image: yup.object().shape({\n    name: yup.string().required(),\n    alternativeText: yup.string().nullable(),\n    url: yup.string().required(),\n    caption: yup.string().nullable(),\n    width: yup.number().required(),\n    height: yup.number().required(),\n    formats: yup.object().required(),\n    hash: yup.string().required(),\n    ext: yup.string().required(),\n    mime: yup.string().required(),\n    size: yup.number().required(),\n    previewUrl: yup.string().nullable(),\n    provider: yup.string().required(),\n    provider_metadata: yup.mixed().nullable(),\n    createdAt: yup.string().required(),\n    updatedAt: yup.string().required(),\n  }),\n  children: yup.array().of(inlineNodeValidator).required(),\n});\n\n// TODO: remove the any and replace with a correct Type\nconst blockNodeValidator: any = yup.lazy((value: { type: string }) => {\n  switch (value.type) {\n    case 'paragraph':\n      return paragraphNodeValidator;\n    case 'heading':\n      return headingNodeValidator;\n    case 'quote':\n      return quoteNodeValidator;\n    case 'list':\n      return listNodeValidator;\n    case 'image':\n      return imageNodeValidator;\n    case 'code':\n      return codeBlockValidator;\n    default:\n      return yup.mixed().test('invalid-type', 'Block node is of invalid type', () => {\n        return false;\n      });\n  }\n});\n\nconst blocksValidatorSchema = yup.array().of(blockNodeValidator);\n\nexport const blocksValidator = () => blocksValidatorSchema;\n"],"names":[],"mappings":";AAEA,MAAM,oBAAoB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC3C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,EAAE,SAAS;AAAA,EAC7C,MAAM,IACH,OAAA,EACA;AAAA,IACC;AAAA,IACA;AAAA,IACA,CAAC,SAAkB;AACV,aAAA,OAAO,SAAS,YAAY,SAAS;AAAA,IAAA;AAAA,EAEhD;AAAA,EACF,MAAM,IAAI,QAAQ;AAAA,EAClB,QAAQ,IAAI,QAAQ;AAAA,EACpB,WAAW,IAAI,QAAQ;AAAA,EACvB,eAAe,IAAI,QAAQ;AAAA,EAC3B,MAAM,IAAI,QAAQ;AACpB,CAAC;AAED,MAAM,iBAAiB,CAAC,SAAiB;AACnC,MAAA;AAEE,QAAA,IAAI,KAAK,WAAW,GAAG,IAAI,oBAAoB,IAAI,KAAK,IAAI;AAAA,WACzD,OAAO;AACP,WAAA;AAAA,EAAA;AAEF,SAAA;AACT;AAEA,MAAM,oBAAoB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC3C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,EAAE,SAAS;AAAA,EAC7C,KAAK,IACF,OAAO,EACP,KAAK,eAAe,gCAAgC,CAAC,UAAU,eAAe,SAAS,EAAE,CAAC;AAAA,EAC7F,UAAU,IAAI,MAAA,EAAQ,GAAG,iBAAiB,EAAE,SAAS;AACvD,CAAC;AAGD,MAAM,sBAA2B,IAAI,KAAK,CAAC,UAA4B;AACrE,UAAQ,MAAM,MAAM;AAAA,IAClB,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT;AACE,aAAO,IAAI,MAAM,EAAE,KAAK,gBAAgB,oCAAoC,MAAM;AACzE,eAAA;AAAA,MAAA,CACR;AAAA,EAAA;AAEP,CAAC;AAED,MAAM,yBAAyB,IAAI,OAAO,EAAE,MAAM;AAAA,EAChD,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,WAAW,CAAC,EAAE,SAAS;AAAA,EAClD,UAAU,IACP,MAAA,EACA,GAAG,mBAAmB,EACtB,IAAI,GAAG,kEAAkE,EACzE,SAAS;AACd,CAAC;AAED,MAAM,uBAAuB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC9C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,SAAS,CAAC,EAAE,SAAS;AAAA,EAChD,OAAO,IAAI,SAAS,MAAM,CAAC,GAAG,GAAG,GAAG,GAAG,GAAG,CAAC,CAAC,EAAE,SAAS;AAAA,EACvD,UAAU,IACP,MAAA,EACA,GAAG,mBAAmB,EACtB,IAAI,GAAG,gEAAgE,EACvE,SAAS;AACd,CAAC;AAED,MAAM,qBAAqB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC5C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,OAAO,CAAC,EAAE,SAAS;AAAA,EAC9C,UAAU,IACP,MAAA,EACA,GAAG,mBAAmB,EACtB,IAAI,GAAG,8DAA8D,EACrE,SAAS;AACd,CAAC;AAED,MAAM,qBAAqB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC5C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,EAAE,SAAS;AAAA,EAC7C,QAAQ,IAAI,OAAO,EAAE,SAAS;AAAA,EAC9B,UAAU,IACP,MAAA,EACA,GAAG,iBAAiB,EACpB,IAAI,GAAG,8DAA8D,EACrE,SAAS;AACd,CAAC;AAED,MAAM,eAAe,IAAI,OAAO,EAAE,MAAM;AAAA,EACtC,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,WAAW,CAAC,EAAE,SAAS;AAAA,EAClD,UAAU,IAAI,MAAA,EAAQ,GAAG,mBAAmB,EAAE,SAAS;AACzD,CAAC;AAID,MAAM,wBAAwB,IAAI,KAAK,CAAC,UAA4B;AAClE,UAAQ,MAAM,MAAM;AAAA,IAClB,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT;AACE,aAAO,IAAI,MAAM,EAAE,KAAK,gBAAgB,yCAAyC,MAAM;AAC9E,eAAA;AAAA,MAAA,CACR;AAAA,EAAA;AAEP,CAAC;AAGD,MAAM,oBAAoB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC3C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,EAAE,SAAS;AAAA,EAC7C,QAAQ,IAAI,SAAS,OAAO,CAAC,WAAW,WAAW,CAAC,EAAE,SAAS;AAAA,EAC/D,UAAU,IACP,MAAA,EACA,GAAG,qBAAqB,EACxB,IAAI,GAAG,gEAAgE,EACvE,SAAS;AACd,CAAC;AAED,MAAM,qBAAqB,IAAI,OAAO,EAAE,MAAM;AAAA,EAC5C,MAAM,IAAI,OAAO,EAAE,OAAO,CAAC,OAAO,CAAC,EAAE,SAAS;AAAA,EAC9C,OAAO,IAAI,OAAO,EAAE,MAAM;AAAA,IACxB,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,IAC5B,iBAAiB,IAAI,OAAO,EAAE,SAAS;AAAA,IACvC,KAAK,IAAI,OAAO,EAAE,SAAS;AAAA,IAC3B,SAAS,IAAI,OAAO,EAAE,SAAS;AAAA,IAC/B,OAAO,IAAI,OAAO,EAAE,SAAS;AAAA,IAC7B,QAAQ,IAAI,OAAO,EAAE,SAAS;AAAA,IAC9B,SAAS,IAAI,OAAO,EAAE,SAAS;AAAA,IAC/B,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,IAC5B,KAAK,IAAI,OAAO,EAAE,SAAS;AAAA,IAC3B,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,IAC5B,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,IAC5B,YAAY,IAAI,OAAO,EAAE,SAAS;AAAA,IAClC,UAAU,IAAI,OAAO,EAAE,SAAS;AAAA,IAChC,mBAAmB,IAAI,MAAM,EAAE,SAAS;AAAA,IACxC,WAAW,IAAI,OAAO,EAAE,SAAS;AAAA,IACjC,WAAW,IAAI,OAAO,EAAE,SAAS;AAAA,EAAA,CAClC;AAAA,EACD,UAAU,IAAI,MAAA,EAAQ,GAAG,mBAAmB,EAAE,SAAS;AACzD,CAAC;AAGD,MAAM,qBAA0B,IAAI,KAAK,CAAC,UAA4B;AACpE,UAAQ,MAAM,MAAM;AAAA,IAClB,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AACI,aAAA;AAAA,IACT;AACE,aAAO,IAAI,MAAM,EAAE,KAAK,gBAAgB,iCAAiC,MAAM;AACtE,eAAA;AAAA,MAAA,CACR;AAAA,EAAA;AAEP,CAAC;AAED,MAAM,wBAAwB,IAAI,QAAQ,GAAG,kBAAkB;AAExD,MAAM,kBAAkB,MAAM;"}