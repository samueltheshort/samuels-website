{"version":3,"file":"index.js","sources":["../../../src/core-api/controller/index.ts"],"sourcesContent":["import { prop } from 'lodash/fp';\nimport type Koa from 'koa';\nimport { contentTypes as contentTypeUtils } from '@strapi/utils';\nimport type { Core, Struct } from '@strapi/types';\n\nimport { transformResponse } from './transform';\nimport { createSingleTypeController } from './single-type';\nimport { createCollectionTypeController } from './collection-type';\nimport requestCtx from '../../services/request-context';\n\nconst isSingleType = (\n  contentType: Struct.ContentTypeSchema\n): contentType is Struct.SingleTypeSchema => contentTypeUtils.isSingleType(contentType);\n\nconst getAuthFromKoaContext = (ctx: Koa.Context) => prop('state.auth', ctx) ?? {};\n\nfunction createController<T extends Struct.SingleTypeSchema | Struct.CollectionTypeSchema>(opts: {\n  contentType: T;\n}): T extends Struct.SingleTypeSchema\n  ? Core.CoreAPI.Controller.SingleType\n  : Core.CoreAPI.Controller.CollectionType;\nfunction createController({\n  contentType,\n}: {\n  contentType: Struct.SingleTypeSchema | Struct.CollectionTypeSchema;\n}) {\n  // TODO: replace with Base class + SingleType and CollectionType classes\n\n  const proto: Core.CoreAPI.Controller.Base = {\n    transformResponse(data, meta) {\n      const ctx = requestCtx.get();\n      return transformResponse(data, meta, {\n        contentType,\n        useJsonAPIFormat: ctx?.headers?.['strapi-response-format'] === 'v4',\n      });\n    },\n\n    async sanitizeOutput(data, ctx) {\n      const auth = getAuthFromKoaContext(ctx);\n\n      return strapi.contentAPI.sanitize.output(data, contentType, { auth });\n    },\n\n    async sanitizeInput(data, ctx) {\n      const auth = getAuthFromKoaContext(ctx);\n\n      return strapi.contentAPI.sanitize.input(data, contentType, { auth });\n    },\n\n    async sanitizeQuery(ctx) {\n      const auth = getAuthFromKoaContext(ctx);\n\n      return strapi.contentAPI.sanitize.query(ctx.query, contentType, { auth });\n    },\n\n    async validateQuery(ctx) {\n      const auth = getAuthFromKoaContext(ctx);\n\n      return strapi.contentAPI.validate.query(ctx.query, contentType, { auth });\n    },\n\n    async validateInput(data, ctx) {\n      const auth = getAuthFromKoaContext(ctx);\n\n      return strapi.contentAPI.validate.input(data, contentType, { auth });\n    },\n  };\n\n  let ctrl;\n\n  if (isSingleType(contentType)) {\n    ctrl = createSingleTypeController({ contentType });\n  } else {\n    ctrl = createCollectionTypeController({ contentType });\n  }\n\n  return Object.assign(Object.create(proto), ctrl);\n}\n\nexport { createController };\n"],"names":["contentTypeUtils","prop","requestCtx","transformResponse","createSingleTypeController","createCollectionTypeController"],"mappings":";;;;;;;;AAUA,MAAM,eAAe,CACnB,gBAC2CA,yBAAiB,aAAa,WAAW;AAEtF,MAAM,wBAAwB,CAAC,QAAqBC,GAAAA,KAAK,cAAc,GAAG,KAAK,CAAC;AAOhF,SAAS,iBAAiB;AAAA,EACxB;AACF,GAEG;AAGD,QAAM,QAAsC;AAAA,IAC1C,kBAAkB,MAAM,MAAM;AACtB,YAAA,MAAMC,eAAW,IAAI;AACpB,aAAAC,UAAA,kBAAkB,MAAM,MAAM;AAAA,QACnC;AAAA,QACA,kBAAkB,KAAK,UAAU,wBAAwB,MAAM;AAAA,MAAA,CAChE;AAAA,IACH;AAAA,IAEA,MAAM,eAAe,MAAM,KAAK;AACxB,YAAA,OAAO,sBAAsB,GAAG;AAE/B,aAAA,OAAO,WAAW,SAAS,OAAO,MAAM,aAAa,EAAE,MAAM;AAAA,IACtE;AAAA,IAEA,MAAM,cAAc,MAAM,KAAK;AACvB,YAAA,OAAO,sBAAsB,GAAG;AAE/B,aAAA,OAAO,WAAW,SAAS,MAAM,MAAM,aAAa,EAAE,MAAM;AAAA,IACrE;AAAA,IAEA,MAAM,cAAc,KAAK;AACjB,YAAA,OAAO,sBAAsB,GAAG;AAE/B,aAAA,OAAO,WAAW,SAAS,MAAM,IAAI,OAAO,aAAa,EAAE,MAAM;AAAA,IAC1E;AAAA,IAEA,MAAM,cAAc,KAAK;AACjB,YAAA,OAAO,sBAAsB,GAAG;AAE/B,aAAA,OAAO,WAAW,SAAS,MAAM,IAAI,OAAO,aAAa,EAAE,MAAM;AAAA,IAC1E;AAAA,IAEA,MAAM,cAAc,MAAM,KAAK;AACvB,YAAA,OAAO,sBAAsB,GAAG;AAE/B,aAAA,OAAO,WAAW,SAAS,MAAM,MAAM,aAAa,EAAE,MAAM;AAAA,IAAA;AAAA,EAEvE;AAEI,MAAA;AAEA,MAAA,aAAa,WAAW,GAAG;AACtB,WAAAC,WAAAA,2BAA2B,EAAE,aAAa;AAAA,EAAA,OAC5C;AACE,WAAAC,eAAAA,+BAA+B,EAAE,aAAa;AAAA,EAAA;AAGvD,SAAO,OAAO,OAAO,OAAO,OAAO,KAAK,GAAG,IAAI;AACjD;;"}