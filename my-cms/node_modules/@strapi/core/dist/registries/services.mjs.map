{"version":3,"file":"services.mjs","sources":["../../src/registries/services.ts"],"sourcesContent":["import { pickBy, has } from 'lodash/fp';\nimport type { Core, UID } from '@strapi/types';\nimport { addNamespace, hasNamespace } from './namespace';\n\nexport type ServiceFactory = (params: { strapi: Core.Strapi }) => Core.Service | Core.Service;\nexport type ServiceFactoryMap = Record<string, ServiceFactory>;\nexport type ServiceMap = Record<string, Core.Service>;\nexport type ServiceExtendFn = (service: Core.Service) => Core.Service;\n\nconst servicesRegistry = (strapi: Core.Strapi) => {\n  const services: ServiceFactoryMap = {};\n  const instantiatedServices: ServiceMap = {};\n\n  return {\n    /**\n     * Returns this list of registered services uids\n     */\n    keys() {\n      return Object.keys(services);\n    },\n\n    /**\n     * Returns the instance of a service. Instantiate the service if not already done\n     */\n    get(uid: UID.Service) {\n      if (instantiatedServices[uid]) {\n        return instantiatedServices[uid];\n      }\n\n      const service = services[uid];\n      if (service) {\n        instantiatedServices[uid] = typeof service === 'function' ? service({ strapi }) : service;\n        return instantiatedServices[uid];\n      }\n    },\n\n    /**\n     * Returns a map with all the services in a namespace\n     */\n    getAll(namespace: string): ServiceMap {\n      const filteredServices = pickBy((_, uid) => hasNamespace(uid, namespace))(services);\n\n      // create lazy accessor to avoid instantiating the services;\n      const map = {};\n      for (const uid of Object.keys(filteredServices)) {\n        Object.defineProperty(map, uid, {\n          enumerable: true,\n          get: () => {\n            return this.get(uid as UID.Service);\n          },\n        });\n      }\n\n      return map;\n    },\n\n    /**\n     * Registers a service\n     */\n    set(uid: string, service: ServiceFactory) {\n      services[uid] = service;\n      delete instantiatedServices[uid];\n      return this;\n    },\n\n    /**\n     * Registers a map of services for a specific namespace\n     */\n    add(namespace: string, newServices: ServiceFactoryMap) {\n      for (const serviceName of Object.keys(newServices)) {\n        const service = newServices[serviceName];\n        const uid = addNamespace(serviceName, namespace);\n\n        if (has(uid, services)) {\n          throw new Error(`Service ${uid} has already been registered.`);\n        }\n        services[uid] = service;\n      }\n\n      return this;\n    },\n\n    /**\n     * Wraps a service to extend it\n     */\n    extend(uid: UID.Service, extendFn: ServiceExtendFn) {\n      const currentService = this.get(uid);\n\n      if (!currentService) {\n        throw new Error(`Service ${uid} doesn't exist`);\n      }\n\n      const newService = extendFn(currentService);\n      instantiatedServices[uid] = newService;\n\n      return this;\n    },\n  };\n};\n\nexport default servicesRegistry;\n"],"names":[],"mappings":";;AASM,MAAA,mBAAmB,CAAC,WAAwB;AAChD,QAAM,WAA8B,CAAC;AACrC,QAAM,uBAAmC,CAAC;AAEnC,SAAA;AAAA;AAAA;AAAA;AAAA,IAIL,OAAO;AACE,aAAA,OAAO,KAAK,QAAQ;AAAA,IAC7B;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,KAAkB;AAChB,UAAA,qBAAqB,GAAG,GAAG;AAC7B,eAAO,qBAAqB,GAAG;AAAA,MAAA;AAG3B,YAAA,UAAU,SAAS,GAAG;AAC5B,UAAI,SAAS;AACU,6BAAA,GAAG,IAAI,OAAO,YAAY,aAAa,QAAQ,EAAE,OAAQ,CAAA,IAAI;AAClF,eAAO,qBAAqB,GAAG;AAAA,MAAA;AAAA,IAEnC;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,WAA+B;AAC9B,YAAA,mBAAmB,OAAO,CAAC,GAAG,QAAQ,aAAa,KAAK,SAAS,CAAC,EAAE,QAAQ;AAGlF,YAAM,MAAM,CAAC;AACb,iBAAW,OAAO,OAAO,KAAK,gBAAgB,GAAG;AACxC,eAAA,eAAe,KAAK,KAAK;AAAA,UAC9B,YAAY;AAAA,UACZ,KAAK,MAAM;AACF,mBAAA,KAAK,IAAI,GAAkB;AAAA,UAAA;AAAA,QACpC,CACD;AAAA,MAAA;AAGI,aAAA;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,KAAa,SAAyB;AACxC,eAAS,GAAG,IAAI;AAChB,aAAO,qBAAqB,GAAG;AACxB,aAAA;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,WAAmB,aAAgC;AACrD,iBAAW,eAAe,OAAO,KAAK,WAAW,GAAG;AAC5C,cAAA,UAAU,YAAY,WAAW;AACjC,cAAA,MAAM,aAAa,aAAa,SAAS;AAE3C,YAAA,IAAI,KAAK,QAAQ,GAAG;AACtB,gBAAM,IAAI,MAAM,WAAW,GAAG,+BAA+B;AAAA,QAAA;AAE/D,iBAAS,GAAG,IAAI;AAAA,MAAA;AAGX,aAAA;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,KAAkB,UAA2B;AAC5C,YAAA,iBAAiB,KAAK,IAAI,GAAG;AAEnC,UAAI,CAAC,gBAAgB;AACnB,cAAM,IAAI,MAAM,WAAW,GAAG,gBAAgB;AAAA,MAAA;AAG1C,YAAA,aAAa,SAAS,cAAc;AAC1C,2BAAqB,GAAG,IAAI;AAErB,aAAA;AAAA,IAAA;AAAA,EAEX;AACF;"}