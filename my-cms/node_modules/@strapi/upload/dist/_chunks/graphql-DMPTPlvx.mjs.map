{"version":3,"file":"graphql-DMPTPlvx.mjs","sources":["../../server/src/graphql.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\n\nimport { FILE_MODEL_UID } from './constants';\n\nconst FILE_INFO_INPUT_TYPE_NAME = 'FileInfoInput';\n\nexport const installGraphqlExtension = ({ strapi }: { strapi: Core.Strapi }) => {\n  const { service: getGraphQLService, config: graphQLConfig } = strapi.plugin('graphql');\n  const { service: getUploadService } = strapi.plugin('upload');\n\n  const isShadowCRUDEnabled = graphQLConfig('shadowCRUD', true);\n\n  if (!isShadowCRUDEnabled) {\n    return;\n  }\n\n  getGraphQLService('extension').shadowCRUD('plugin::upload.folder').disable();\n  getGraphQLService('extension').shadowCRUD('plugin::upload.file').disableMutations();\n\n  const { getTypeName } = getGraphQLService('utils').naming;\n\n  const fileModel = strapi.getModel(FILE_MODEL_UID);\n  const fileTypeName = getTypeName(fileModel);\n  /**\n   * Register Upload's types, queries & mutations to the content API using the GraphQL extension API\n   */\n  getGraphQLService('extension').use(({ nexus }: { nexus: any }) => {\n    const { inputObjectType, extendType, nonNull } = nexus;\n\n    // Represents the input data payload for the file's information\n    const fileInfoInputType = inputObjectType({\n      name: FILE_INFO_INPUT_TYPE_NAME,\n\n      definition(t: any) {\n        t.string('name');\n        t.string('alternativeText');\n        t.string('caption');\n      },\n    });\n\n    const mutations = extendType({\n      type: 'Mutation',\n\n      definition(t: any) {\n        /**\n         * Update some information for a given file\n         */\n        t.field('updateUploadFile', {\n          type: nonNull(fileTypeName),\n\n          args: {\n            id: nonNull('ID'),\n            info: FILE_INFO_INPUT_TYPE_NAME,\n          },\n\n          async resolve(parent: unknown, args: { id: number; info: any }) {\n            const { id, info } = args;\n\n            return getUploadService('upload').updateFileInfo(id, info);\n          },\n        });\n\n        /**\n         * Delete & remove a given file\n         */\n        t.field('deleteUploadFile', {\n          type: fileTypeName,\n\n          args: {\n            id: nonNull('ID'),\n          },\n\n          async resolve(parent: unknown, args: { id: number }) {\n            const { id } = args;\n\n            const file = await getUploadService('upload').findOne(id);\n\n            if (!file) {\n              return null;\n            }\n\n            return getUploadService('upload').remove(file);\n          },\n        });\n      },\n    });\n\n    return {\n      types: [fileInfoInputType, mutations],\n      resolversConfig: {\n        // Use custom scopes for the upload file CRUD operations\n        'Query.uploadFiles': { auth: { scope: 'plugin::upload.content-api.find' } },\n        'Query.uploadFiles_connection': { auth: { scope: 'plugin::upload.content-api.find' } },\n        'Query.uploadFile': { auth: { scope: 'plugin::upload.content-api.findOne' } },\n        'Mutation.updateUploadFile': { auth: { scope: 'plugin::upload.content-api.upload' } },\n        'Mutation.deleteUploadFile': { auth: { scope: 'plugin::upload.content-api.destroy' } },\n      },\n    };\n  });\n};\n"],"names":[],"mappings":";AAIA,MAAM,4BAA4B;AAE3B,MAAM,0BAA0B,CAAC,EAAE,aAAsC;AACxE,QAAA,EAAE,SAAS,mBAAmB,QAAQ,kBAAkB,OAAO,OAAO,SAAS;AACrF,QAAM,EAAE,SAAS,iBAAA,IAAqB,OAAO,OAAO,QAAQ;AAEtD,QAAA,sBAAsB,cAAc,cAAc,IAAI;AAE5D,MAAI,CAAC,qBAAqB;AACxB;AAAA,EAAA;AAGF,oBAAkB,WAAW,EAAE,WAAW,uBAAuB,EAAE,QAAQ;AAC3E,oBAAkB,WAAW,EAAE,WAAW,qBAAqB,EAAE,iBAAiB;AAElF,QAAM,EAAE,YAAgB,IAAA,kBAAkB,OAAO,EAAE;AAE7C,QAAA,YAAY,OAAO,SAAS,cAAc;AAC1C,QAAA,eAAe,YAAY,SAAS;AAI1C,oBAAkB,WAAW,EAAE,IAAI,CAAC,EAAE,YAA4B;AAChE,UAAM,EAAE,iBAAiB,YAAY,QAAY,IAAA;AAGjD,UAAM,oBAAoB,gBAAgB;AAAA,MACxC,MAAM;AAAA,MAEN,WAAW,GAAQ;AACjB,UAAE,OAAO,MAAM;AACf,UAAE,OAAO,iBAAiB;AAC1B,UAAE,OAAO,SAAS;AAAA,MAAA;AAAA,IACpB,CACD;AAED,UAAM,YAAY,WAAW;AAAA,MAC3B,MAAM;AAAA,MAEN,WAAW,GAAQ;AAIjB,UAAE,MAAM,oBAAoB;AAAA,UAC1B,MAAM,QAAQ,YAAY;AAAA,UAE1B,MAAM;AAAA,YACJ,IAAI,QAAQ,IAAI;AAAA,YAChB,MAAM;AAAA,UACR;AAAA,UAEA,MAAM,QAAQ,QAAiB,MAAiC;AACxD,kBAAA,EAAE,IAAI,KAAA,IAAS;AAErB,mBAAO,iBAAiB,QAAQ,EAAE,eAAe,IAAI,IAAI;AAAA,UAAA;AAAA,QAC3D,CACD;AAKD,UAAE,MAAM,oBAAoB;AAAA,UAC1B,MAAM;AAAA,UAEN,MAAM;AAAA,YACJ,IAAI,QAAQ,IAAI;AAAA,UAClB;AAAA,UAEA,MAAM,QAAQ,QAAiB,MAAsB;AAC7C,kBAAA,EAAE,OAAO;AAEf,kBAAM,OAAO,MAAM,iBAAiB,QAAQ,EAAE,QAAQ,EAAE;AAExD,gBAAI,CAAC,MAAM;AACF,qBAAA;AAAA,YAAA;AAGT,mBAAO,iBAAiB,QAAQ,EAAE,OAAO,IAAI;AAAA,UAAA;AAAA,QAC/C,CACD;AAAA,MAAA;AAAA,IACH,CACD;AAEM,WAAA;AAAA,MACL,OAAO,CAAC,mBAAmB,SAAS;AAAA,MACpC,iBAAiB;AAAA;AAAA,QAEf,qBAAqB,EAAE,MAAM,EAAE,OAAO,oCAAoC;AAAA,QAC1E,gCAAgC,EAAE,MAAM,EAAE,OAAO,oCAAoC;AAAA,QACrF,oBAAoB,EAAE,MAAM,EAAE,OAAO,uCAAuC;AAAA,QAC5E,6BAA6B,EAAE,MAAM,EAAE,OAAO,sCAAsC;AAAA,QACpF,6BAA6B,EAAE,MAAM,EAAE,OAAO,qCAAuC,EAAA;AAAA,MAAA;AAAA,IAEzF;AAAA,EAAA,CACD;AACH;"}