{"version":3,"file":"watch.mjs","sources":["../../../src/node/webpack/watch.ts"],"sourcesContent":["import os from 'node:os';\nimport path from 'node:path';\nimport { promisify } from 'node:util';\nimport webpackDevMiddleware from 'webpack-dev-middleware';\nimport webpackHotMiddleware from 'webpack-hot-middleware';\nimport { webpack } from 'webpack';\nimport { Core } from '@strapi/types';\nimport type { BuildContext } from '../create-build-context';\nimport { mergeConfigWithUserConfig, resolveDevelopmentConfig } from './config';\n\ninterface WebpackWatcher {\n  close(): Promise<void>;\n}\n\nconst watch = async (ctx: BuildContext): Promise<WebpackWatcher> => {\n  const config = await resolveDevelopmentConfig(ctx);\n  const finalConfig = await mergeConfigWithUserConfig(config, ctx);\n\n  ctx.logger.debug('Final webpack config:', os.EOL, finalConfig);\n\n  return new Promise<WebpackWatcher>((res) => {\n    const compiler = webpack(finalConfig);\n\n    const devMiddleware = webpackDevMiddleware(compiler);\n\n    const hotMiddleware = webpackHotMiddleware(compiler, {\n      log: false,\n      path: '/__webpack_hmr',\n    });\n\n    ctx.strapi.server.app.use((ctx, next) => {\n      return new Promise((resolve, reject) => {\n        hotMiddleware(ctx.req, ctx.res, (err) => {\n          if (err) reject(err);\n          else resolve(next());\n        });\n      });\n    });\n\n    ctx.strapi.server.app.use((context, next) => {\n      // wait for webpack-dev-middleware to signal that the build is ready\n      const ready = new Promise((resolve) => {\n        devMiddleware.waitUntilValid(() => {\n          resolve(true);\n        });\n      });\n      // tell webpack-dev-middleware to handle the request\n      const init = new Promise((resolve) => {\n        devMiddleware(\n          context.req,\n          {\n            // @ts-expect-error ignored\n            end(content) {\n              // eslint-disable-next-line no-param-reassign\n              context.body = content;\n              resolve(true);\n            },\n            getHeader: context.get.bind(context),\n            // @ts-expect-error ignored\n            setHeader: context.set.bind(context),\n            locals: context.state,\n          },\n          () => resolve(next())\n        );\n      });\n\n      return Promise.all([ready, init]);\n    });\n\n    const serveAdmin: Core.MiddlewareHandler = async (ctx, next) => {\n      await next();\n\n      if (devMiddleware.context.outputFileSystem.createReadStream) {\n        if (ctx.method !== 'HEAD' && ctx.method !== 'GET') {\n          return;\n        }\n\n        if (ctx.body != null || ctx.status !== 404) {\n          return;\n        }\n\n        // eslint-disable-next-line @typescript-eslint/no-non-null-asserted-optional-chain\n        const filename = path.resolve(finalConfig.output?.path!, 'index.html');\n        ctx.type = 'html';\n        ctx.body = devMiddleware.context.outputFileSystem.createReadStream(filename);\n      }\n    };\n\n    ctx.strapi.server.routes([\n      {\n        method: 'GET',\n        path: `${ctx.adminPath}/:path*`,\n        handler: serveAdmin,\n        config: { auth: false },\n      },\n    ]);\n\n    devMiddleware.waitUntilValid(() => {\n      res({\n        async close() {\n          await Promise.all([\n            promisify(devMiddleware.close.bind(devMiddleware))(),\n            hotMiddleware.close(),\n            promisify(compiler.close.bind(compiler))(),\n          ]);\n        },\n      });\n    });\n  });\n};\n\nexport { watch };\nexport type { WebpackWatcher };\n"],"names":["ctx"],"mappings":";;;;;;;AAcM,MAAA,QAAQ,OAAO,QAA+C;AAC5D,QAAA,SAAS,MAAM,yBAAyB,GAAG;AACjD,QAAM,cAAc,MAAM,0BAA0B,QAAQ,GAAG;AAE/D,MAAI,OAAO,MAAM,yBAAyB,GAAG,KAAK,WAAW;AAEtD,SAAA,IAAI,QAAwB,CAAC,QAAQ;AACpC,UAAA,WAAW,QAAQ,WAAW;AAE9B,UAAA,gBAAgB,qBAAqB,QAAQ;AAE7C,UAAA,gBAAgB,qBAAqB,UAAU;AAAA,MACnD,KAAK;AAAA,MACL,MAAM;AAAA,IAAA,CACP;AAED,QAAI,OAAO,OAAO,IAAI,IAAI,CAACA,MAAK,SAAS;AACvC,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,sBAAcA,KAAI,KAAKA,KAAI,KAAK,CAAC,QAAQ;AACnC,cAAA,YAAY,GAAG;AAAA,cACd,SAAQ,MAAM;AAAA,QAAA,CACpB;AAAA,MAAA,CACF;AAAA,IAAA,CACF;AAED,QAAI,OAAO,OAAO,IAAI,IAAI,CAAC,SAAS,SAAS;AAE3C,YAAM,QAAQ,IAAI,QAAQ,CAAC,YAAY;AACrC,sBAAc,eAAe,MAAM;AACjC,kBAAQ,IAAI;AAAA,QAAA,CACb;AAAA,MAAA,CACF;AAED,YAAM,OAAO,IAAI,QAAQ,CAAC,YAAY;AACpC;AAAA,UACE,QAAQ;AAAA,UACR;AAAA;AAAA,YAEE,IAAI,SAAS;AAEX,sBAAQ,OAAO;AACf,sBAAQ,IAAI;AAAA,YACd;AAAA,YACA,WAAW,QAAQ,IAAI,KAAK,OAAO;AAAA;AAAA,YAEnC,WAAW,QAAQ,IAAI,KAAK,OAAO;AAAA,YACnC,QAAQ,QAAQ;AAAA,UAClB;AAAA,UACA,MAAM,QAAQ,KAAM,CAAA;AAAA,QACtB;AAAA,MAAA,CACD;AAED,aAAO,QAAQ,IAAI,CAAC,OAAO,IAAI,CAAC;AAAA,IAAA,CACjC;AAEK,UAAA,aAAqC,OAAOA,MAAK,SAAS;AAC9D,YAAM,KAAK;AAEP,UAAA,cAAc,QAAQ,iBAAiB,kBAAkB;AAC3D,YAAIA,KAAI,WAAW,UAAUA,KAAI,WAAW,OAAO;AACjD;AAAA,QAAA;AAGF,YAAIA,KAAI,QAAQ,QAAQA,KAAI,WAAW,KAAK;AAC1C;AAAA,QAAA;AAIF,cAAM,WAAW,KAAK,QAAQ,YAAY,QAAQ,MAAO,YAAY;AACrEA,aAAI,OAAO;AACXA,aAAI,OAAO,cAAc,QAAQ,iBAAiB,iBAAiB,QAAQ;AAAA,MAAA;AAAA,IAE/E;AAEI,QAAA,OAAO,OAAO,OAAO;AAAA,MACvB;AAAA,QACE,QAAQ;AAAA,QACR,MAAM,GAAG,IAAI,SAAS;AAAA,QACtB,SAAS;AAAA,QACT,QAAQ,EAAE,MAAM,MAAM;AAAA,MAAA;AAAA,IACxB,CACD;AAED,kBAAc,eAAe,MAAM;AAC7B,UAAA;AAAA,QACF,MAAM,QAAQ;AACZ,gBAAM,QAAQ,IAAI;AAAA,YAChB,UAAU,cAAc,MAAM,KAAK,aAAa,CAAC,EAAE;AAAA,YACnD,cAAc,MAAM;AAAA,YACpB,UAAU,SAAS,MAAM,KAAK,QAAQ,CAAC,EAAE;AAAA,UAAA,CAC1C;AAAA,QAAA;AAAA,MACH,CACD;AAAA,IAAA,CACF;AAAA,EAAA,CACF;AACH;"}