{"version":3,"file":"plugins.mjs","sources":["../../../src/node/vite/plugins.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport { getDocumentHTML } from '../staticFiles';\nimport type { BuildContext } from '../create-build-context';\n\nconst buildFilesPlugin = (ctx: BuildContext): Plugin => {\n  const CHUNK_ID = '.strapi/client/app.js';\n\n  return {\n    name: 'strapi/server/build-files',\n    apply: 'build',\n    buildStart() {\n      this.emitFile({\n        type: 'chunk',\n        id: CHUNK_ID,\n        name: 'strapi',\n      });\n    },\n    async generateBundle(_options, outputBundle) {\n      const bundle = outputBundle;\n      const entryFile = Object.values(bundle).find(\n        (file) =>\n          file.type === 'chunk' && file.name === 'strapi' && file.facadeModuleId?.endsWith(CHUNK_ID)\n      );\n\n      if (!entryFile) {\n        throw new Error(`Failed to find entry file in bundle (${CHUNK_ID})`);\n      }\n\n      if (entryFile.type !== 'chunk') {\n        throw new Error('Entry file is not a chunk');\n      }\n\n      const entryFileName = entryFile.fileName;\n      const entryPath = [ctx.basePath.replace(/\\/+$/, ''), entryFileName].join('/');\n\n      this.emitFile({\n        type: 'asset',\n        fileName: 'index.html',\n        source: getDocumentHTML({\n          logger: ctx.logger,\n          props: {\n            entryPath,\n          },\n        }),\n      });\n    },\n  };\n};\n\nexport { buildFilesPlugin };\n"],"names":[],"mappings":";AAKM,MAAA,mBAAmB,CAAC,QAA8B;AACtD,QAAM,WAAW;AAEV,SAAA;AAAA,IACL,MAAM;AAAA,IACN,OAAO;AAAA,IACP,aAAa;AACX,WAAK,SAAS;AAAA,QACZ,MAAM;AAAA,QACN,IAAI;AAAA,QACJ,MAAM;AAAA,MAAA,CACP;AAAA,IACH;AAAA,IACA,MAAM,eAAe,UAAU,cAAc;AAC3C,YAAM,SAAS;AACf,YAAM,YAAY,OAAO,OAAO,MAAM,EAAE;AAAA,QACtC,CAAC,SACC,KAAK,SAAS,WAAW,KAAK,SAAS,YAAY,KAAK,gBAAgB,SAAS,QAAQ;AAAA,MAC7F;AAEA,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,MAAM,wCAAwC,QAAQ,GAAG;AAAA,MAAA;AAGjE,UAAA,UAAU,SAAS,SAAS;AACxB,cAAA,IAAI,MAAM,2BAA2B;AAAA,MAAA;AAG7C,YAAM,gBAAgB,UAAU;AAC1B,YAAA,YAAY,CAAC,IAAI,SAAS,QAAQ,QAAQ,EAAE,GAAG,aAAa,EAAE,KAAK,GAAG;AAE5E,WAAK,SAAS;AAAA,QACZ,MAAM;AAAA,QACN,UAAU;AAAA,QACV,QAAQ,gBAAgB;AAAA,UACtB,QAAQ,IAAI;AAAA,UACZ,OAAO;AAAA,YACL;AAAA,UAAA;AAAA,QAEH,CAAA;AAAA,MAAA,CACF;AAAA,IAAA;AAAA,EAEL;AACF;"}