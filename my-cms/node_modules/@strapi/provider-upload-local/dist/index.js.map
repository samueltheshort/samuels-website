{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { pipeline } from 'stream';\nimport fs, { ReadStream } from 'fs';\nimport path from 'path';\nimport fse from 'fs-extra';\nimport * as utils from '@strapi/utils';\n\n// Needed to load global.strapi without having to put @strapi/types in the regular dependencies\nimport type {} from '@strapi/types';\n\ninterface File {\n  name: string;\n  alternativeText?: string;\n  caption?: string;\n  width?: number;\n  height?: number;\n  formats?: Record<string, unknown>;\n  hash: string;\n  ext?: string;\n  mime: string;\n  size: number;\n  sizeInBytes: number;\n  url: string;\n  previewUrl?: string;\n  path?: string;\n  provider?: string;\n  provider_metadata?: Record<string, unknown>;\n  stream?: ReadStream;\n  buffer?: Buffer;\n}\n\nconst { PayloadTooLargeError } = utils.errors;\nconst { kbytesToBytes, bytesToHumanReadable } = utils.file;\n\nconst UPLOADS_FOLDER_NAME = 'uploads';\n\ninterface InitOptions {\n  sizeLimit?: number;\n}\n\ninterface CheckFileSizeOptions {\n  sizeLimit?: number;\n}\n\nexport default {\n  init({ sizeLimit: providerOptionsSizeLimit }: InitOptions = {}) {\n    // TODO V5: remove providerOptions sizeLimit\n    if (providerOptionsSizeLimit) {\n      process.emitWarning(\n        '[deprecated] In future versions, \"sizeLimit\" argument will be ignored from upload.config.providerOptions. Move it to upload.config'\n      );\n    }\n\n    // Ensure uploads folder exists\n    const uploadPath = path.resolve(strapi.dirs.static.public, UPLOADS_FOLDER_NAME);\n    if (!fse.pathExistsSync(uploadPath)) {\n      throw new Error(\n        `The upload folder (${uploadPath}) doesn't exist or is not accessible. Please make sure it exists.`\n      );\n    }\n\n    return {\n      checkFileSize(file: File, options: CheckFileSizeOptions) {\n        const { sizeLimit } = options ?? {};\n\n        // TODO V5: remove providerOptions sizeLimit\n        if (providerOptionsSizeLimit) {\n          if (kbytesToBytes(file.size) > providerOptionsSizeLimit)\n            throw new PayloadTooLargeError(\n              `${file.name} exceeds size limit of ${bytesToHumanReadable(\n                providerOptionsSizeLimit\n              )}.`\n            );\n        } else if (sizeLimit) {\n          if (kbytesToBytes(file.size) > sizeLimit)\n            throw new PayloadTooLargeError(\n              `${file.name} exceeds size limit of ${bytesToHumanReadable(sizeLimit)}.`\n            );\n        }\n      },\n      uploadStream(file: File): Promise<void> {\n        if (!file.stream) {\n          return Promise.reject(new Error('Missing file stream'));\n        }\n\n        const { stream } = file;\n\n        return new Promise((resolve, reject) => {\n          pipeline(\n            stream,\n            fs.createWriteStream(path.join(uploadPath, `${file.hash}${file.ext}`)),\n            (err) => {\n              if (err) {\n                return reject(err);\n              }\n\n              file.url = `/${UPLOADS_FOLDER_NAME}/${file.hash}${file.ext}`;\n\n              resolve();\n            }\n          );\n        });\n      },\n      upload(file: File): Promise<void> {\n        if (!file.buffer) {\n          return Promise.reject(new Error('Missing file buffer'));\n        }\n\n        const { buffer } = file;\n\n        return new Promise((resolve, reject) => {\n          // write file in public/assets folder\n          fs.writeFile(path.join(uploadPath, `${file.hash}${file.ext}`), buffer, (err) => {\n            if (err) {\n              return reject(err);\n            }\n\n            file.url = `/${UPLOADS_FOLDER_NAME}/${file.hash}${file.ext}`;\n\n            resolve();\n          });\n        });\n      },\n      delete(file: File): Promise<string | void> {\n        return new Promise((resolve, reject) => {\n          const filePath = path.join(uploadPath, `${file.hash}${file.ext}`);\n\n          if (!fs.existsSync(filePath)) {\n            resolve(\"File doesn't exist\");\n            return;\n          }\n\n          // remove file from public/assets folder\n          fs.unlink(filePath, (err) => {\n            if (err) {\n              return reject(err);\n            }\n\n            resolve();\n          });\n        });\n      },\n    };\n  },\n};\n"],"names":["utils","path","fse","stream","pipeline","fs"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8BA,MAAM,EAAE,qBAAqB,IAAIA,iBAAM;AACvC,MAAM,EAAE,eAAe,yBAAyBA,iBAAM;AAEtD,MAAM,sBAAsB;AAU5B,MAAe,QAAA;AAAA,EACb,KAAK,EAAE,WAAW,yBAAyB,IAAiB,CAAA,GAAI;AAE9D,QAAI,0BAA0B;AACpB,cAAA;AAAA,QACN;AAAA,MACF;AAAA,IAAA;AAIF,UAAM,aAAaC,cAAK,QAAA,QAAQ,OAAO,KAAK,OAAO,QAAQ,mBAAmB;AAC9E,QAAI,CAACC,aAAA,QAAI,eAAe,UAAU,GAAG;AACnC,YAAM,IAAI;AAAA,QACR,sBAAsB,UAAU;AAAA,MAClC;AAAA,IAAA;AAGK,WAAA;AAAA,MACL,cAAc,MAAY,SAA+B;AACvD,cAAM,EAAE,cAAc,WAAW,CAAC;AAGlC,YAAI,0BAA0B;AACxB,cAAA,cAAc,KAAK,IAAI,IAAI;AAC7B,kBAAM,IAAI;AAAA,cACR,GAAG,KAAK,IAAI,0BAA0B;AAAA,gBACpC;AAAA,cAAA,CACD;AAAA,YACH;AAAA,mBACO,WAAW;AAChB,cAAA,cAAc,KAAK,IAAI,IAAI;AAC7B,kBAAM,IAAI;AAAA,cACR,GAAG,KAAK,IAAI,0BAA0B,qBAAqB,SAAS,CAAC;AAAA,YACvE;AAAA,QAAA;AAAA,MAEN;AAAA,MACA,aAAa,MAA2B;AAClC,YAAA,CAAC,KAAK,QAAQ;AAChB,iBAAO,QAAQ,OAAO,IAAI,MAAM,qBAAqB,CAAC;AAAA,QAAA;AAGlD,cAAA,EAAA,QAAEC,aAAW;AAEnB,eAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCC,iBAAA;AAAA,YACED;AAAAA,YACAE,YAAAA,QAAG,kBAAkBJ,sBAAK,KAAK,YAAY,GAAG,KAAK,IAAI,GAAG,KAAK,GAAG,EAAE,CAAC;AAAA,YACrE,CAAC,QAAQ;AACP,kBAAI,KAAK;AACP,uBAAO,OAAO,GAAG;AAAA,cAAA;AAGd,mBAAA,MAAM,IAAI,mBAAmB,IAAI,KAAK,IAAI,GAAG,KAAK,GAAG;AAElD,sBAAA;AAAA,YAAA;AAAA,UAEZ;AAAA,QAAA,CACD;AAAA,MACH;AAAA,MACA,OAAO,MAA2B;AAC5B,YAAA,CAAC,KAAK,QAAQ;AAChB,iBAAO,QAAQ,OAAO,IAAI,MAAM,qBAAqB,CAAC;AAAA,QAAA;AAGlD,cAAA,EAAE,WAAW;AAEnB,eAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEtCI,sBAAA,QAAG,UAAUJ,cAAA,QAAK,KAAK,YAAY,GAAG,KAAK,IAAI,GAAG,KAAK,GAAG,EAAE,GAAG,QAAQ,CAAC,QAAQ;AAC9E,gBAAI,KAAK;AACP,qBAAO,OAAO,GAAG;AAAA,YAAA;AAGd,iBAAA,MAAM,IAAI,mBAAmB,IAAI,KAAK,IAAI,GAAG,KAAK,GAAG;AAElD,oBAAA;AAAA,UAAA,CACT;AAAA,QAAA,CACF;AAAA,MACH;AAAA,MACA,OAAO,MAAoC;AACzC,eAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAChC,gBAAA,WAAWA,cAAAA,QAAK,KAAK,YAAY,GAAG,KAAK,IAAI,GAAG,KAAK,GAAG,EAAE;AAEhE,cAAI,CAACI,YAAA,QAAG,WAAW,QAAQ,GAAG;AAC5B,oBAAQ,oBAAoB;AAC5B;AAAA,UAAA;AAICA,sBAAAA,QAAA,OAAO,UAAU,CAAC,QAAQ;AAC3B,gBAAI,KAAK;AACP,qBAAO,OAAO,GAAG;AAAA,YAAA;AAGX,oBAAA;AAAA,UAAA,CACT;AAAA,QAAA,CACF;AAAA,MAAA;AAAA,IAEL;AAAA,EAAA;AAEJ;;"}